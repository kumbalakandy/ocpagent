I-LDAP Authentication
=====================


1. Create Secret
---------------
oc create secret generic ldap-secret --from-literal=bindPassword=asd123.. -n openshift-config

OR 

echo -n 'MyP@ssw0rd!' | base64

----
apiVersion: v1
kind: Secret
metadata:
  name: ldap-secret
  namespace: openshift-config
type: Opaque
data:
  bindPassword: Vk13YXJlMSE=

2. LDAPS CA Cert ConfigMap
--------------------------

oc create configmap ldap-ca-config-map--from-file=ca.crt=CA.cer -n openshift-config 

OR

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ldap-ca-config-map
  namespace: openshift-config
data:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDmTCCAoGgAwIBAgIQX+5pVgEYDbxG9Ud1OCYlkzANBgkqhkiG9w0BAQsFADBT
    MRMwEQYKCZImiZPyLGQBGRYDY29tMRswGQYKCZImiZPyLGQBGRYLa29kZXZpcnR1
    YWwxHzAdBgNVBAMTFmxhYi1kYy5rb2RldmlydHVhbC5jb20wHhcNMjQwMjE1MTEx
    MTUwWhcNMjkwMjE1MTEyMTQ5WjBTMRMwEQYKCZImiZPyLGQBGRYDY29tMRswGQYK
    CZImiZPyLGQBGRYLa29kZXZpcnR1YWwxHzAdBgNVBAMTFmxhYi1kYy5rb2Rldmly
    dHVhbC5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCcTwF3Ry8G
    lpybLSydzkSAifHb45FTeOLPEIOG5Thj+BUHJ4VG8P080OowY8LdjZmbyfbFuLOf
    aarTszZH75RdgFE0hV7kD/SGUzK4JmsZn7QWPhsH8L57ip/sxuInElLlSM6o/NYP
    8dCwsZjgkT741QaipJL+MbSJXev7OBYuAFVLud/NJpvSJ54YpA8G+LVAZv693JE2
    95Os7MtyWrrwLMrsGpfBctrk9ArSJySFkzvLLOlX5mGYEy1Cc/bzNSSTHkky+GX5
    8c492JC+UA2GVjhkutXcPIw50DWVS+TbJ3tAoSziJL42LxKHzsJ35yL+EjoRK9Vx
    ffHBo2X37eUdAgMBAAGjaTBnMBMGCSsGAQQBgjcUAgQGHgQAQwBBMA4GA1UdDwEB
    /wQEAwIBhjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBSz9iJXXiG4Q2iikWmG
    1TKqrl982jAQBgkrBgEEAYI3FQEEAwIBADANBgkqhkiG9w0BAQsFAAOCAQEAcm3I
    JzLApJ+7YK0pim7xr26lACKIgcoR3kJ2O3i+FES9c4z3korqhgokZTnTTh1mGENy
    Gyarcvm5d7PvShaMtX1IWEkoCmW7Xa0mjB4BYMLwxceLauQEqTldBO3sku4EOtx5
    RETqb81bJ4IZpipDks6LLY/5G+K+pCqxEAC1etEEXeSeH01MB1OnmuLA2iCktci/
    AKbfkbL0V9Fic2YqzNG4WyCOBtVeh0sgr9ZWOP0spe8OAw8cKOy2/e8gr3ZWlYAH
    EJDBSZyxPOoAYQ7nIcaheTaud3WdLxbS1ASmspiG56iUTsqKB4EzhsYRg1elJ9IQ
    P01w1Zl5U673H1VR/A==
    -----END CERTIFICATE-----
3. Update the existing OauthConfig
----------------------------------
spec:
  identityProviders:
  - name: corporate-ldap
    mappingMethod: claim
    type: LDAP
    ldap:
      attributes:
        id: dn
        email: mail
        name:  cn 
        preferredUsername:  sAMAccountName
      bindDN: 'CN=OCP SVC Account,OU=service_admin,DC=kodevirtual,DC=com'
      bindPassword:
        name: ldap-secret
      ca:
        name: ldap-ca-config-map
      insecure: false
      url: 'ldaps://kodevirtual.com/DC=kodevirtual,DC=com?sAMAccountName?sub?(|(memberOf=CN=admins ocp,OU=OCP Admins,DC=kodevirtual,DC=com)(memberOf=CN=Operator Ocp,OU=OCP Admins,DC=kodevirtual,DC=com))'
  tokenConfig:
    accessTokenMaxAgeSeconds: 86400



apiVersion: v1
kind: Namespace
metadata:
  labels:
    openshift.io/cluster-monitoring: "true"
  name: group-sync-operator

---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: group-sync-operator
  namespace: group-sync-operator
spec:
  targetNamespaces:
    - group-sync-operator

---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: group-sync-operator
  namespace: group-sync-operator
spec:
  channel: alpha
  installPlanApproval: Automatic
  name: group-sync-operator
  source: community-operators
  sourceNamespace: openshift-marketplace
  startingCSV: group-sync-operator.v0.0.36






II - LDAP Synchronization
=================================
1. Create User Secret
----------------------------
echo -n 'cn=svc_ocp_ad,ou=service_admin,dc=kodevirtual,dc=com' | base64

echo -n 'R3DH@t_2025' | base64

---
apiVersion: v1
kind: Secret
metadata:
  name: ldap-group-sync
  namespace: group-sync-operator
type: Opaque
data:
  username: Y249c3ZjX29jcF9hZCxvdT1zZXJ2aWNlX2FkbWluLGRjPWtvZGV2aXJ0dWFsLGRjPWNvbQ==
  password: Vk13YXJlMSE=

OR

oc create secret generic ldap-group-sync --from-literal=username='cn=svc_ocp_ad,ou=service_admin,dc=kodevirtual,dc=com' --from-literal=password=R3DH@t_2025 -n group-sync-operator
base64 

2. Create CA Secret
------------------
oc -n group-sync-operator create secret generic ldap-ca-cert   --from-file=ca.crt=CA.cer

OR


base64 -w0 CA.pem 

apiVersion: v1
kind: Secret
metadata:
  name: ldap-ca-cert
  namespace: group-sync-operator
type: Opaque
data:
  ca.crt: |    LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdLRENDQlJDZ0F3SUJBZ0lUY0FBQUFCVDJpVGxmWERVdEp3QUFBQUFBRkRBTkJna3Foa2lHOXcwQkFRc0YKQURCVE1STXdFUVlLQ1pJbWlaUHlMR1FCR1JZRFkyOXRNUnN3R1FZS0NaSW1pWlB5TEdRQkdSWUxhMjlrWlhacApjblIxWVd3eEh6QWRCZ05WQkFNVEZteGhZaTFrWXk1cmIyUmxkbWx5ZEhWaGJDNWpiMjB3SGhjTk1qUXhNVEk1Ck1UQTFOREV4V2hjTk1qVXhNVEk1TVRBMU5ERXhXakFBTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEEKTUlJQkNnS0NBUUVBdkVZdFQ3Y2N3UVV4RDJWQTEzZzdIaUgyY0J2WXlWay80SGd3MmliL3lHTi94d040NVFlbgo5MjEzbjA2OU5EcEZqR3BzL2dicjR6VWpKSXppMHFTWXZtVkZYeXlOSGFHdExFa1dlYlFsODlBcE1UMU1jM1Z4Ck83Z2NmRUZuWWkrd1BvM3poSk5RNFh6QTdaOStWT2ZNeHBNUzZkb1pjdFJLYi9FN1M3eXVhbjE5V0NBb3hjbE0KWjlMWTB0L2pvYm5KTXJGUFlldUVCSHhZdW9oMFBhRldLdlM0bE5nbENQNTcrbU1ubzZJa3F5eFg3Zmh3eEh2TwpEaEtIQ2cwbGVYQ0VLZU1OdkNNNlUzOEtPQWs1UFFkbjc1U05iOTBVS2lSNVNDT2pwWlhwQkkrMU5oMVZnR09rCkx0WDJJNHc3RTk1OVJnNW9DNEFkcUNLbnlzNTRYZ2E1OVFJREFRQUJvNElEUmpDQ0EwSXdQUVlKS3dZQkJBR0MKTnhVSEJEQXdMZ1ltS3dZQkJBR0NOeFVJdkprK2hNT1djNE8xaHgrQ3hlVUZoK25kYW9FbmgrRHlhWVBNL1ZFQwpBV1FDQVFJd01nWURWUjBsQkNzd0tRWUhLd1lCQlFJREJRWUtLd1lCQkFHQ054UUNBZ1lJS3dZQkJRVUhBd0VHCkNDc0dBUVVGQndNQ01BNEdBMVVkRHdFQi93UUVBd0lGb0RCQUJna3JCZ0VFQVlJM0ZRb0VNekF4TUFrR0J5c0cKQVFVQ0F3VXdEQVlLS3dZQkJBR0NOeFFDQWpBS0JnZ3JCZ0VGQlFjREFUQUtCZ2dyQmdFRkJRY0RBakFkQmdOVgpIUTRFRmdRVSszYXhFblVNNnNVTFJESG1wZmoySjJYMzYxRXdId1lEVlIwakJCZ3dGb0FVcy9ZaVYxNGh1RU5vCm9wRnBodFV5cXE1ZmZOb3dnZGNHQTFVZEh3U0J6ekNCekRDQnlhQ0J4cUNCdzRhQndHeGtZWEE2THk4dlEwNDkKYkdGaUxXUmpMbXR2WkdWMmFYSjBkV0ZzTG1OdmJTeERUajFzWVdJdFpHTXNRMDQ5UTBSUUxFTk9QVkIxWW14cApZeVV5TUV0bGVTVXlNRk5sY25acFkyVnpMRU5PUFZObGNuWnBZMlZ6TEVOT1BVTnZibVpwWjNWeVlYUnBiMjRzClJFTTlhMjlrWlhacGNuUjFZV3dzUkVNOVkyOXRQMk5sY25ScFptbGpZWFJsVW1WMmIyTmhkR2x2Ymt4cGMzUS8KWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqVWt4RWFYTjBjbWxpZFhScGIyNVFiMmx1ZERDQnpBWUlLd1lCQlFVSApBUUVFZ2I4d2did3dnYmtHQ0NzR0FRVUZCekFDaG9Hc2JHUmhjRG92THk5RFRqMXNZV0l0WkdNdWEyOWtaWFpwCmNuUjFZV3d1WTI5dExFTk9QVUZKUVN4RFRqMVFkV0pzYVdNbE1qQkxaWGtsTWpCVFpYSjJhV05sY3l4RFRqMVQKWlhKMmFXTmxjeXhEVGoxRGIyNW1hV2QxY21GMGFXOXVMRVJEUFd0dlpHVjJhWEowZFdGc0xFUkRQV052YlQ5agpRVU5sY25ScFptbGpZWFJsUDJKaGMyVS9iMkpxWldOMFEyeGhjM005WTJWeWRHbG1hV05oZEdsdmJrRjFkR2h2CmNtbDBlVEJDQmdOVkhSRUJBZjhFT0RBMmdoWnNZV0l0WkdNdWEyOWtaWFpwY25SMVlXd3VZMjl0Z2c5cmIyUmwKZG1seWRIVmhiQzVqYjIyQ0MwdFBSRVZXU1ZKVVZVRk1NRTRHQ1NzR0FRUUJnamNaQWdSQk1EK2dQUVlLS3dZQgpCQUdDTnhrQ0FhQXZCQzFUTFRFdE5TMHlNUzB6TlRJMU9ESTBPVEEwTFRFME16Y3pNRGsxTmpBdE5qRTNOelkyCk9UazVMVEV3TURBd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFCZ09ESGhnSHlsOVNVZHZrTlZuL21hOFdaL3UKM1YxQXJlMUF1NnpZbjRQK25CTlBpVHVJU1JNUHgycXo3RFBqZTZ5bFJ4NFJCK2p0NkhoTVdDcGhMMnFwL2NXdApkOVlXTG43RHMySnd3L0JWR05wZ3FBUlgxVzRDa3lRODhJRUNRdncyc2hOSTQrdVlaTDYzSmVhSWdqdzdKWG0zCmh6Ky9OemNOTWMzMkJQUE9OcVQ3TmxwbkFkY3JMNytkYzB5WTd1aWZmdHZFYjY2NTQ3ZndsSXkwODdQWUd4M3EKSzFqY0REZUNoMW8yVml4WVVlVzM4QXorU2hPTDdnSGROWFZ5ekU5MG5XZDRDUkdQNmVBWmU2ZjhWYWR4YitvdQpTT1c0YWo5MzJCdXAvdndYbjErdUVJYm5aY3FneVU2eTJaakFLWStuR2Q4a2loalRzNitpWGtXdm9UQT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
3. Create GroupSync
-----------------

apiVersion: redhatcop.redhat.io/v1alpha1
kind: GroupSync
metadata:
  name: ldap-groupsync
spec:
  providers:
  - ldap:
      credentialsSecret:
        name: ldap-group-sync
        namespace: group-sync-operator
      insecure: false
      ca:
        name: ldap-ca-cert
        namespace: group-sync-operator
        kind: Secret
      rfc2307:
        groupMembershipAttributes:
        - member
        groupNameAttributes:
        - cn
        groupUIDAttribute: dn
        groupsQuery:
          baseDN: 'OU=Tier 1, OU=Admins,DC=kodevirtual,DC=com'
          derefAliases: never
          filter: (objectClass=group)
          scope: sub
        tolerateMemberNotFoundErrors: true
        tolerateMemberOutOfScopeErrors: true
        userNameAttributes:
        - sAMAccountName
        userUIDAttribute: dn
        usersQuery:
          baseDN: 'OU=Tier 1, OU=Admins,DC=kodevirtual,DC=com'
          derefAliases: never
          scope: sub
      url: 'ldaps://kodevirtual.com:636'
    name: ldap
  schedule: '*/5 * * * *'

4. Blacklist
-----------
apiVersion: redhatcop.redhat.io/v1alpha1
kind: GroupSync
metadata:
  name: ldap-groupsync
spec:
  providers:
  - ldap:
...
      blacklist:
      - cn=Finance,ou=Groups,dc=example,dc=com
...
    name: ldap


ldaps://kodevirtual.com/DC=kodevirtual,DC=com?sAMAccountName?sub?(&
 (objectCategory=person)
 (objectClass=user)
 (!(userAccountControl:1.2.840.113556.1.4.803:=2))
 (memberOf:1.2.840.113556.1.4.1941:=CN=OCP_Tenants,OU=OCP Admins,DC=kodevirtual,DC=com)
)
