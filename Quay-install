---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    openshift.io/cluster-monitoring: "true"
  name: quay-enterprise
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  generateName: quay-enterprise
  name: quay-enterprise
  namespace: quay-enterprise
spec:
  upgradeStrategy: Default
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: quay-operator
  namespace: quay-enterprise
spec:
  channel: stable-3.15
  installPlanApproval: Automatic
  name: quay-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  startingCSV: quay-operator.v3.15.2


DISTRIBUTED_STORAGE_CONFIG:
  default:
    - RHOCSStorage
    - access_key: WmrXtSGk8B3nABCDEFGH
      bucket_name: my-noobaa-bucket-claim-8b844191-dc6c-444e-9ea4-87ece0abcdef
      hostname: s3.openshift-storage.svc.cluster.local
      is_secure: true
      port: "443"
      secret_key: X9P5SDGJtmSuHFCMSLMbdNCMfUABCDEFGH+C5QD
      storage_path: /datastorage/registry
DISTRIBUTED_STORAGE_DEFAULT_LOCATIONS: []
DISTRIBUTED_STORAGE_PREFERENCE:
  - default
  
  

oc create secret generic --from-file config.yaml=./config.yaml --from-file ssl.cert=./ssl.cert --from-file ssl.key=./ssl.key config-bundle-secret



quay: Minimum of 6 GB, 2vCPUs
clair: Recommended of 2 GB memory, 2 vCPUs
clairpostgres: Minimum of 200 MB




spec:
  components:
    - kind: clair
      managed: true
      overrides:
        resources:
          limits:
            cpu: "5"     # Limiting to 5 CPU (equivalent to 5000m or 5000 millicpu)
            memory: "18Gi"  # Limiting to 18 Gibibytes of memory
          requests:
            cpu: "4"     # Requesting 4 CPU
            memory: "4Gi"   # Requesting 4 Gibibytes of memory
    - kind: postgres
      managed: true
      overrides:
        resources:
          limits: {} 
          requests:
            cpu: "700m"   # Requesting 700 millicpu or 0.7 CPU
            memory: "4Gi"   # Requesting 4 Gibibytes of memory
    - kind: mirror
      managed: true
      overrides:
        resources:
          limits: 
          requests:
            cpu: "800m"   # Requesting 800 millicpu or 0.8 CPU
            memory: "1Gi"   # Requesting 1 Gibibyte of memory
    - kind: quay
      managed: true
      overrides:
        resources:
          limits:
            cpu: "4"    # Limiting to 4 CPU
            memory: "10Gi"   # Limiting to 10 Gibibytes of memory
          requests:
            cpu: "4"   # Requesting 4 CPU
            memory: "10Gi"   # Requesting 10 Gibi of memory
    - kind: clairpostgres
      managed: true
      overrides:
        resources:
          limits:
            cpu: "800m"   # Limiting to 800 millicpu or 0.8 CPU
            memory: "3Gi"   # Limiting to 3 Gibibytes of memory
          requests: {}
		  
apiVersion: quay.redhat.com/v1
kind: QuayRegistry
metadata:
  name: <example_registry>
  namespace: <namespace>
  spec:
    configBundleSecret: config-bundle-secret
    components:
    - kind: quay
      managed: true
    - kind: postgres
      managed: true
    - kind: clair
      managed: true
    - kind: redis
      managed: true
    - kind: horizontalpodautoscaler
      managed: true
    - kind: objectstorage
      managed: true
    - kind: route
      managed: true
    - kind: mirror
      managed: true
    - kind: monitoring
      managed: true
    - kind: tls
      managed: true
    - kind: clairpostgres
      managed: true		  
		  
		  
updating existing config bundle-secret
========================================

oc describe quayregistry -n <quay_namespace>

oc get secret -n <quay_namespace> <example-registry-config-bundle-v123x> -o jsonpath='{.data}'

echo 'RkVBVFVSRV9VU0 ... MDAwMAo=' | base64 --decode >> config.yaml

touch <new_configBundleSecret_name>.yaml

oc -n <namespace> create secret generic <secret_name> \
  --from-file=config.yaml=</path/to/config.yaml> \
  --dry-run=client -o yaml > <new_configBundleSecret_name>.yaml
  
  oc create -n <namespace> -f <new_configBundleSecret_name>.yaml
  
  
  oc patch quayregistry <registry_name> -n <namespace> --type=merge -p '{"spec":{"configBundleSecret":"<new_configBundleSecret_name>"}}'
  
  
  
FOOTER_LINKS:
  "TERMS_OF_SERVICE_URL": "https://www.index.hr"
  "PRIVACY_POLICY_URL": "https://www.example.hr"
  "SECURITY_URL": "https://www.example.hr"
  "ABOUT_URL": "https://www.example.hr"
  
  
  
AUTHENTICATION_TYPE: Database
PREFERRED_URL_SCHEME: https
SERVER_HOSTNAME: quay.kodevirtual.com
FEATURE_FIPS = true
SETUP_COMPLETE: true
FEATURE_PROXY_CACHE
# ...


kind: HorizontalPodAutoscaler
apiVersion: autoscaling/v2
metadata:
  name: quay-registry-quay-app
  namespace: quay-enterprise
spec:
  scaleTargetRef:
    kind: Deployment
    name: quay-registry-quay-app
    apiVersion: apps/v1
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 90
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 90


$ cat <<EOF > config.yaml
ALLOW_PULLS_WITHOUT_STRICT_LOGGING: false
AUTHENTICATION_TYPE: Database
DEFAULT_TAG_EXPIRATION: 2w
FEATURE_USER_INITIALIZE: true 
SUPER_USERS: 
     -  quayadmin
BROWSER_API_CALLS_XHR_ONLY: false 
FEATURE_USER_CREATION: false 
FEATURE_BUILD_SUPPORT: false
FEATURE_DIRECT_LOGIN: true
FEATURE_MAILING: false
REGISTRY_TITLE: Red Hat Quay
REGISTRY_TITLE_SHORT: Red Hat Quay
SETUP_COMPLETE: true
TAG_EXPIRATION_OPTIONS:
- 2w
- 1w
- 3d
TEAM_RESYNC_STALE_TIME: 60m
TESTING: false
SERVER_HOSTNAME: quay.kodevirtual.com
FEATURE_FIPS: true
FEATURE_PROXY_CACHE: true
FEATURE_SUPERUSERS_FULL_ACCESS: True
FEATURE_QUOTA_MANAGEMENT: true
DEFAULT_SYSTEM_REJECT_QUOTA_BYTES: "100gb"
QUOTA_BACKFILL: true
QUOTA_TOTAL_DELAY_SECONDS: "3600"
PERMANENTLY_DELETE_TAGS: true
RESET_CHILD_MANIFEST_EXPIRATION: true



----
ALLOW_PULLS_WITHOUT_STRICT_LOGGING: false
AUTHENTICATION_TYPE: Database
DEFAULT_TAG_EXPIRATION: 2w
FEATURE_USER_INITIALIZE: true 
SUPER_USERS: 
     -  quayadmin
BROWSER_API_CALLS_XHR_ONLY: false 
FEATURE_USER_CREATION: true
FEATURE_BUILD_SUPPORT: false
FEATURE_DIRECT_LOGIN: true
FEATURE_MAILING: false
REGISTRY_TITLE: Red Hat Quay
REGISTRY_TITLE_SHORT: Red Hat Quay
SETUP_COMPLETE: true
TAG_EXPIRATION_OPTIONS:
- 2w
- 1w
- 1d
- 2d
- 3d
TEAM_RESYNC_STALE_TIME: 60m
TESTING: false
FEATURE_FIPS:  true
FEATURE_PROXY_CACHE: true
FEATURE_SUPERUSERS_FULL_ACCESS: true
FEATURE_QUOTA_MANAGEMENT: true
DEFAULT_SYSTEM_REJECT_QUOTA_BYTES: "250gb"
QUOTA_BACKFILL: true
QUOTA_TOTAL_DELAY_SECONDS: "3600"
PERMANENTLY_DELETE_TAGS: true
RESET_CHILD_MANIFEST_EXPIRATION: true
FEATURE_REPO_MIRROR: true



oc create secret generic <quay_config_bundle_name> \
  --from-file=config.yaml=</path/to/config.yaml> \
  -n quay-enterprise \
  --dry-run=client -o yaml | oc apply


  components:
    - kind: clair
      managed: true
    - kind: postgres
      managed: true
    - kind: objectstorage
      managed: true
    - kind: redis
      managed: true
    - kind: horizontalpodautoscaler
      managed: true
    - kind: route
      managed: true
    - kind: mirror
      managed: true
    - kind: monitoring
      managed: true
    - kind: tls
      managed: true
    - kind: quay
      managed: true
    - kind: clairpostgres
      managed: true



apiVersion: quay.redhat.com/v1
kind: QuayRegistry
metadata:
  name: kvquay
  namespace: quay-enterprise
spec:
  configBundleSecret: quay-config-bundle
  components:
    - kind: clair
      managed: false
    - kind: postgres
      managed: true
      overrides:
        volumeSize: 1Ti
        resources:
          limits:
            cpu: "8"    # Limiting to 4 CPU
            memory: "32Gi"   # Limiting to 10 Gibibytes of memory
          requests:
            cpu: "2"   # Requesting 700 millicpu or 0.7 CPU
            memory: "12Gi"   # Requesting 4 Gibibytes of memory
    - kind: mirror
      managed: true
      overrides:
	    replicas: 5 #up to 10
        resources:
          limits: 
          requests:
            cpu: "2"   # Requesting 800 millicpu or 0.8 CPU
            memory: "2Gi"   # Requesting 1 Gibibyte of memory
    - kind: quay
      managed: true
      overrides:
        resources:
          limits:
            cpu: "4"    # Limiting to 4 CPU
            memory: "10Gi"   # Limiting to 10 Gibibytes of memory
          requests:
            cpu: "4"   # Requesting 4 CPU
            memory: "10Gi"   # Requesting 10 Gibi of memory
    - kind: clairpostgres
      managed: false
    - managed: true
      kind: redis
      overrides:
        resources:
          limits:
            cpu: "2"    # Limiting to 4 CPU
            memory: "4Gi"   # Limiting to 10 Gibibytes of memory
          requests:
            cpu: "1" 
            memory: "2Gi"
    - managed: true
      kind: objectstorage
    - managed: true
      kind: horizontalpodautoscaler
    - managed: true
      kind: route
    - managed: true
      kind: monitoring
    - managed: true
      kind: tls


----USED----


apiVersion: quay.redhat.com/v1
kind: QuayRegistry
metadata:
  name: kvquay
  namespace: quay-enterprise
spec:
  components:
    - kind: clair
      managed: false
    - kind: postgres
      managed: true
      overrides:
        resources:
          limits:
            cpu: '8'
            memory: 32Gi
          requests:
            cpu: '4'
            memory: 24Gi
    - kind: mirror
      managed: true
      overrides:
        resources:
          requests:
            cpu: '2'
            memory: 2Gi
    - kind: quay
      managed: true
      overrides:
        resources:
          limits:
            cpu: '4'
            memory: 10Gi
          requests:
            cpu: '4'
            memory: 10Gi
    - kind: clairpostgres
      managed: false
    - kind: redis
      managed: true
    - kind: objectstorage
      managed: true
    - kind: horizontalpodautoscaler
      managed: true
    - kind: route
      managed: true
    - kind: monitoring
      managed: true
    - kind: tls
      managed: true
  configBundleSecret: quay-config-bundle

	  



sudo cp rootCA.pem /etc/containers/certs.d/quay-server.example.com/ca.crt


oc -n <namespace> create secret generic custom-ssl-config-bundle-secret \
  --from-file=config.yaml=</path/to/config.yaml> \
  --from-file=ssl.cert=</path/to/ssl.cert> \
  --from-file=extra_ca_cert_<name-of-certificate>.crt=ca-certificate-bundle.crt
  
  
oc patch quayregistry <registry_name> -n <namespace> --type=merge -p '{"spec":{"configBundleSecret":"custom-ssl-config-bundle-secret"}}'


oc -n <namespace> create secret generic extra-ca-certificate-config-bundle-secret \
  --from-file=config.yaml=</path/to/config.yaml> \
  --from-file=extra_ca_cert_<name-of-certificate-one>=<path/to/certificate_one> \
  --from-file=extra_ca_cert_<name-of-certificate-two>=<path/to/certificate_two> \
  --from-file=extra_ca_cert_<name-of-certificate-three>=<path/to/certificate_three> \
  --dry-run=client -o yaml > extra-ca-certificate-config-bundle-secret.yaml

(&(objectClass=user)(memberOf:1.2.840.113556.1.4.1941:=CN=Target Group Name,OU=Groups,DC=example,DC=com))



CN=quay-groups,OU=ocp,DC=kodevirtual,DC=com

CN=quay-group1,CN=Users,DC=kodevirtual,DC=com

3YRW68Q40HIXTWJX7EB42ZQJID8MG4J7



oc -n <namespace> create secret generic extra-ca-certificate-config-bundle-secret \
  --from-file=config.yaml=</path/to/config.yaml> \
  --from-file=extra_ca_cert_<name-of-certificate-one>=<path/to/certificate_one> \
  --from-file=extra_ca_cert_<name-of-certificate-two>=<path/to/certificate_two> \
  --from-file=extra_ca_cert_<name-of-certificate-three>=<path/to/certificate_three> \
  --dry-run=client -o yaml > extra-ca-certificate-config-bundle-secret.yaml






ALLOW_PULLS_WITHOUT_STRICT_LOGGING: false
AUTHENTICATION_TYPE: LDAP
DEFAULT_TAG_EXPIRATION: 2w
SERVER_HOSTNAME:
FEATURE_USER_INITIALIZE: true 
SUPER_USERS: 
     -  arasheed@kodevirtual.com
BROWSER_API_CALLS_XHR_ONLY: false 
FEATURE_USER_CREATION: true
FEATURE_BUILD_SUPPORT: false
FEATURE_DIRECT_LOGIN: true
FEATURE_MAILING: false
REGISTRY_TITLE: Red Hat Quay
REGISTRY_TITLE_SHORT: Red Hat Quay
SETUP_COMPLETE: true
TAG_EXPIRATION_OPTIONS:
- 2w
- 1w
- 1d
- 2d
- 3d
TEAM_RESYNC_STALE_TIME: 60m
TESTING: false
FEATURE_FIPS:  true
FEATURE_PROXY_CACHE: true
FEATURE_SUPERUSERS_FULL_ACCESS: true
FEATURE_QUOTA_MANAGEMENT: true
DEFAULT_SYSTEM_REJECT_QUOTA_BYTES: "250gb"
QUOTA_BACKFILL: true
QUOTA_TOTAL_DELAY_SECONDS: 3600
PERMANENTLY_DELETE_TAGS: true
RESET_CHILD_MANIFEST_EXPIRATION: true
FEATURE_REPO_MIRROR: true
LDAP_ADMIN_DN: "CN=Quay SVC,OU=service_admin,DC=kodevirtual,DC=com"
LDAP_ADMIN_PASSWD: "P@ssw0rd"
LDAP_ALLOW_INSECURE_FALLBACK: false
LDAP_BASE_DN:
    - dc=kodevirtual
    - dc=com
LDAP_EMAIL_ATTR: mail
LDAP_UID_ATTR: userPrincipalName
LDAP_URI: ldaps://lab-dc.kodevirtual.com
LDAP_USER_FILTER: (memberOf=CN=quay users,CN=Users,DC=kodevirtual,DC=com)
LDAP_SUPERUSER_FILTER: (memberOf=CN=Quay Admins,CN=Users,DC=kodevirtual,DC=com)


apiVersion: quay.redhat.com/v1
kind: QuayRegistry
metadata:
  name: quay
  namespace: registry
spec:
  components:
    - kind: clair
      managed: false
    - kind: postgres
      managed: true
      overrides:
        resources:
          limits:
            cpu: '8'
            memory: 32Gi
          requests:
            cpu: '4'
            memory: 24Gi
    - kind: mirror
      managed: true
      overrides:
        resources:
          requests:
            cpu: '2'
            memory: 2Gi
    - kind: quay
      managed: true
      overrides:
        resources:
          limits:
            cpu: '4'
            memory: 10Gi
          requests:
            cpu: '4'
            memory: 10Gi
    - kind: clairpostgres
      managed: false
    - kind: redis
      managed: true
    - kind: objectstorage
      managed: true
    - kind: horizontalpodautoscaler
      managed: true
    - kind: route
      managed: true
    - kind: monitoring
      managed: true
    - kind: tls
      managed: true
  configBundleSecret: config-bundle-secret





(&(objectClass=user)(memberOf:1.2.840.113556.1.4.1941:=CN=quay-groups,OU=ocp,DC=kodevirtual,DC=com))


"Display name:
hub-ph-ocp-wld-sa
Useraccount:
svcphocpwld

 
ThisUserForPH3@lth
CN=hub-ph-ocp-wld,OU=Service Accounts-Local,DC=purehealth,DC=local"



CN=hub-ph-ocp-admin,OU=HUB-PH-OCPOU,DC=purehealth,DC=local

