apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: logging-obc
  namespace: openshift-storage
spec:
  generateBucketName: logging-obc
  storageClassName: openshift-storage.noobaa.io
  additionalConfig:
    maxSize: "500G"
---
apiVersion: v1
kind: Secret
metadata:
  name: s3-secret-logging
  namespace: openshift-logging
stringData:
  access_key_id: wq5VKSnbBPmXUJrdY5Hd
  access_key_secret: lpjJ0Mvs0uvCKUnn+PltdfxCgrIh18AXzggeKMg1
  bucketnames: logging-obc-ca6f56f4-37ce-46ba-bc3a-a305970f0512
  endpoint: https://s3-openshift-storage.apps.aan-zdc-seha-edge-clu01.purecloud.ae

---
apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: logging-loki
  namespace: openshift-logging
spec:
  limits:
   global:
      ingestion:
        perStreamRateLimit: 5
        perStreamRateLimitBurst: 20
      retention:
        days: 3
        streams:
        - days: 2
          priority: 1
          selector: '{log_type="application"}'
        - days: 1
          priority: 1
          selector: '{log_type="infrastructure"}'
  managementState: Managed
  replicationFactor: 2
  size: 1x.small
  storage:
    schemas:
    - version: v13
      effectiveDate: "2025-01-01"
    secret:
      name: loki-s3-logging
      type: s3
      credentialMode: static
    tls:
       caName: loki-s3-ca
  storageClassName: aan-zdc-seha-edge-clu01-block-replica3
  tenants:
    mode: openshift-logging

spec:
  limits:
    global:
      ingestion:
        ingestionBurstSize: 40
        ingestionRate: 20
        maxGlobalStreamsPerTenant: 25000
      queries:
        maxChunksPerQuery: 2000000
        maxEntriesLimitPerQuery: 10000
        maxQuerySeries: 3000
        queryTimeout: 3m
      retention:
        days: 3
        streams:
        - days: 2
          priority: 1
          selector: '{log_type="application"}'
        - days: 1
          priority: 1
          selector: '{log_type="infrastructure"}'
  managementState: Managed
  replicationFactor: 2
  size: 1x.small
  storage:
    schemas:
    - effectiveDate: "2025-01-01"
      version: v13
    secret:
      credentialMode: static
      name: s3-secret-logging
      type: s3
    tls:
      caName: loki-s3-ca
  storageClassName: aan-zdc-seha-edge-clu01-block-replica3
  tenants:
    mode: openshift-logging


---
apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: qradar
  namespace: openshift-logging
spec:
  collector:
    resources:
      limits:
        cpu: '6'
        memory: 8Gi
      requests:
        cpu: '4'
        memory: 4Gi
  filters:
    - drop:
        - test:
            - field: .log_type
              matches: application|infrastructure
            - field: .level
              notMatches: (?i)warning|error|critical|fatal
      name: loki-severity-filter
      type: drop
    - drop:
        - test:
            - field: .log_type
              matches: application|infrastructure
            - field: .level
              notMatches: (?i)warning|error|critical|fatal
      name: syslog-severity-filter
      type: drop
  inputs:
    - audit:
        sources:
          - kubeAPI
          - openshiftAPI
      name: log-audit
      type: audit
    - application: {}
      name: log-app
      type: application
    - infrastructure:
        sources:
          - node
          - container
      name: log-infra
      type: infrastructure
  managementState: Managed
  outputs:
    - name: qradar
      syslog:
        appName: kubeAudit
        enrichment: KubernetesMinimal
        facility: user
        payloadKey: '{.message}'
        rfc: RFC5424
        severity: warning
        url: 'tcp://10.115.4.106:514'
      type: syslog
    - lokiStack:
        authentication:
          token:
            from: serviceAccount
        target:
          name: logging-loki
          namespace: openshift-logging
      name: default-lokistack
      tls:
        ca:
          configMapName: openshift-service-ca.crt
          key: service-ca.crt
      type: lokiStack
  pipelines:
    - filterRefs:
        - loki-severity-filter
      inputRefs:
        - log-audit
        - log-app
        - log-infra
      name: to-lokistack
      outputRefs:
        - default-lokistack
    - filterRefs:
        - syslog-severity-filter
      inputRefs:
        - log-audit
        - log-app
        - log-infra
      name: to-external-syslog
      outputRefs:
        - qradar
  serviceAccount:
    name: logcollector

---
apiVersion: observability.openshift.io/v1alpha1
kind: UIPlugin
metadata:
  name: logging
spec:
  type: Logging
  logging:
    lokiStack:
      name: logging-loki
    logsLimit: 50
    timeout: 30s
